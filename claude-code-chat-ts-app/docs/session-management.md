# Claude Code SDK セッション管理について

## 重要な発見

Claude Code SDKのセッション管理について、以下の重要な点が判明しました：

### 1. セッションIDの性質

- **セッションIDは各リクエストごとに新しく生成される**
- これは単なるリクエスト追跡用のIDであり、会話の継続性を保証するものではない
- 実際の会話コンテキストはサーバー側で管理される

### 2. 会話の継続方法

- **`--continue`フラグ**: 最新の会話を継続
- **`--resume`フラグ**: 特定のセッションを再開（ただし、新しいセッションIDが生成される）
- いずれの場合も、サーバー側で会話履歴が保持される

### 3. 実装上の考慮事項

```typescript
// 既存セッションを継続する場合
const queryOptions = {
  continue: true,  // これによりサーバー側で前の会話コンテキストが使用される
  // その他のオプション...
};
```

### 4. セッションIDの変更への対応

- クライアント側では、セッションIDが変わることを想定した実装が必要
- 新しいセッションIDを受け取ったら、内部の管理を更新する

### 5. なぜこのような設計なのか

- ステートレスなクライアント実装が可能
- サーバー側で会話履歴を一元管理
- 各リクエストを独立して追跡可能
- スケーラビリティとセキュリティの向上

## 実装例

```typescript
// 新規会話開始
for await (const message of query({
  prompt: "Hello",
  options: { /* オプション */ }
})) {
  // 新しいセッションIDが生成される
}

// 会話の継続
for await (const message of query({
  prompt: "Continue our discussion",
  options: { 
    continue: true  // 前の会話コンテキストを使用
  }
})) {
  // 新しいセッションIDが生成されるが、会話は継続される
}
```

## まとめ

セッションIDが変わることは**正常な動作**です。重要なのは`--continue`フラグを使用することで、サーバー側で会話コンテキストが維持されることです。