# アプリ名

Claude Code Chat

# アプリ概要

- Claude Code SDK を使用して、Claude Code とマルチターン会話ができる Web アプリを実装します。
- 言語は TypeScript で実装します。
- なるべく、画面上で Claude Code の設定可能な項目を設定できるようにしてください。

# フレームワーク

## 必要な環境

- **Node.js**: Claude Code SDK の実行に必須
- **npm**: パッケージ管理

## シンプル構成（推奨）

### フロントエンド

- **Vite + React + TypeScript**: 高速な開発環境とシンプルなセットアップ
- **CSS Modules**: React コンポーネントごとにスタイルを管理

### バックエンド

- **Express.js**: シンプルな Node.js サーバー
- **@anthropic-ai/claude-code**: Claude Code SDK をサーバーサイドで実行
- WebSocket または Server-Sent Events (SSE)でストリーミングレスポンスをクライアントに送信

### 特徴

- セットアップが比較的簡単
- Claude Code SDK は Node.js 環境で動作するため、バックエンドが必要
- API キーをサーバーサイドで安全に管理
- ストリーミングレスポンスに対応

## 代替構成

### より統合的な構成

- **Next.js + TypeScript**: フロントエンドとバックエンドを統一
- **API Routes**: Next.js 内で Claude Code SDK を実行
- Vercel へのデプロイが簡単

### 最小構成

- **素の HTML + Express.js**: フロントエンドは静的ファイル
- **Vanilla JavaScript/TypeScript**: フレームワークなし
- 最もシンプルだが、UI の実装に時間がかかる

# 探索結果

## Claude Code SDK の主要機能

### 基本的な使用方法

- **TypeScript SDK**: `@anthropic-ai/claude-code` パッケージを使用
- **非同期ストリーミング**: `for await` ループでメッセージを順次受信
- **中断機能**: `AbortController` で処理をキャンセル可能

### 設定可能な項目（UI で実装すべき機能）

#### 必須設定

- **API キー**: `ANTHROPIC_API_KEY` 環境変数（サーバーサイドで管理）

#### 会話制御

- **--max-turns**: 最大ターン数の制限（非対話モードでの制御）
- **--continue**: 最新の会話を継続
- **--resume**: セッション ID で特定の会話を再開

#### システムプロンプト

- **--system-prompt**: システムプロンプトの完全な上書き
- **--append-system-prompt**: デフォルトプロンプトへの追加指示

#### 出力形式

- **--output-format**:
  - `text`: テキストのみ（デフォルト）
  - `json`: メタデータ付き構造化データ
  - `stream-json`: ストリーミング JSON（リアルタイム表示に最適）

#### ツール制御

- **--allowedTools**: 使用を許可するツールのリスト
- **--disallowedTools**: 使用を禁止するツールのリスト
- **--permission-mode**: 権限モード設定

#### MCP（Model Context Protocol）設定

- **--mcp-config**: MCP サーバー設定ファイルの指定
- **--permission-prompt-tool**: 権限確認用 MCP ツール

### メッセージスキーマ

- **assistant**: アシスタントのメッセージ
- **user**: ユーザーのメッセージ
- **result**: 会話終了時の結果（成功/エラー、コスト、所要時間など）
- **system**: 初期化時のシステム情報

### 実装上の重要ポイント

1. **Node.js 必須**: Claude Code SDK は Node.js 環境でのみ動作
2. **ストリーミング対応**: `stream-json`形式でリアルタイムレスポンス表示
3. **セッション管理**: `session_id`を使用した会話の継続・再開
4. **コスト表示**: `total_cost_usd`で API 使用料金を表示可能
5. **エラーハンドリング**: `error_max_turns`、`error_during_execution`などのエラー種別

# 作業計画

## フェーズ1: プロジェクトの初期設定（完了）

### 1.1 開発環境のセットアップ
- [x] Node.jsプロジェクトの初期化
- [x] 必要なパッケージのインストール
- [x] TypeScript設定の作成
- [x] Vite設定の作成
- [x] `.gitignore`と`.env.example`の作成

### 1.2 プロジェクト構造の作成
- [x] ディレクトリ構造の構築

## フェーズ2: バックエンドの実装（完了）

### 2.1 Expressサーバーの基本実装
- [x] Express基本設定（CORS、JSON解析など）
- [x] 環境変数の読み込み（`ANTHROPIC_API_KEY`）
- [x] エラーハンドリングミドルウェア

### 2.2 Claude Code SDK統合
- [x] Claude Code SDKのラッパークラス作成
- [x] ストリーミングレスポンス用のSSEエンドポイント実装
- [x] セッション管理機能（メモリストアで開始）

### 2.3 APIエンドポイントの実装
- [x] POST `/api/chat/start` - 新規会話開始
- [x] POST `/api/chat/continue` - 会話継続
- [x] GET `/api/chat/sessions/:id` - セッション情報取得
- [x] DELETE `/api/chat/sessions/:id/abort` - 処理中断
- [x] GET `/api/chat/cwd` - デフォルト作業ディレクトリ取得

## フェーズ3: フロントエンドの実装（完了）

### 3.1 基本UIコンポーネント
- [x] メインレイアウト（ヘッダー、サイドバー、チャットエリア）
- [x] メッセージコンポーネント（ユーザー/アシスタント）
- [x] 入力フォームコンポーネント
- [x] 設定パネルコンポーネント
- [x] メッセージ詳細表示コンポーネント

### 3.2 状態管理の実装
- [x] React Contextでグローバル状態管理
- [x] 会話履歴の管理
- [x] 設定情報の管理（ローカルストレージ連携）

### 3.3 SSE接続とストリーミング表示
- [x] Fetch APIを使用したSSE接続
- [x] ストリーミングメッセージのリアルタイム表示
- [x] エラーハンドリング

## フェーズ4: 設定機能の実装（完了）

### 4.1 設定可能項目のUI実装
- [x] モデル選択（claude-sonnet-4-20250514, claude-opus-4-20250514）
- [x] システムプロンプト設定（テキストエリア）
- [x] 追加システムプロンプト設定
- [x] 作業ディレクトリ（cwd）設定
- [x] 最大ターン数設定（スライダー）
- [x] 許可/禁止ツール設定（チェックボックスリスト）
- [x] 出力形式選択（ラジオボタン）

### 4.2 設定の永続化
- [x] ローカルストレージへの保存
- [x] 設定のインポート/エクスポート機能

## フェーズ5: 高度な機能の実装（部分的に完了）

### 5.1 セッション管理機能
- [x] セッション一覧表示
- [x] セッションの継続機能（--resumeオプション使用）
- [x] セッションIDの表示と管理

### 5.2 エラーハンドリングとUX改善
- [x] エラーメッセージの適切な表示
- [x] ローディング状態の表示
- [x] 処理中断機能（AbortController）
- [x] コスト表示機能
- [x] 日本語入力のIME問題修正
- [x] 空メッセージの非表示
- [x] ヘッダー固定とスクロール問題の修正

### 5.3 レスポンシブデザイン（完了）
- [x] モバイル対応レイアウト
  - ハンバーガーメニューの実装
  - サイドバーのスライド式表示
  - レスポンシブな文字サイズとスペーシング
- [x] タッチ操作の最適化
  - iOS対応のフォントサイズ設定（ズーム防止）
  - モバイルでの入力補助機能の無効化
  - タッチフレンドリーなボタンサイズ

## フェーズ6: テストとデプロイ（9-10日目）

### 6.1 テスト
- [ ] 単体テストの作成（主要コンポーネント）
- [ ] E2Eテストの実装（基本的なユーザーフロー）
- [ ] 手動テスト（各種エッジケース）

### 6.2 最適化
- [ ] バンドルサイズの最適化
- [ ] パフォーマンスチューニング

### 6.3 デプロイ準備
- [ ] 本番環境用の設定
- [ ] デプロイメントドキュメントの作成
- [ ] CI/CD設定（オプション）

## 優先度とMVP

### MVP（最小限の実装）- フェーズ1-3
- 基本的なチャット機能
- ストリーミングレスポンス表示
- APIキー設定

### 追加機能 - フェーズ4-6
- 詳細な設定オプション
- セッション管理
- エラーハンドリングの充実

## 技術的な注意点

1. **セキュリティ**: APIキーは必ずサーバーサイドで管理
2. **スケーラビリティ**: 初期はメモリストアで実装し、後でRedis等に移行可能な設計
3. **エラー処理**: ネットワークエラー、API制限、タイムアウトなどを適切に処理
4. **型安全性**: TypeScriptの型定義を最大限活用

## 重要な発見事項

### Claude Code Maxプラン対応
- APIキーなしでClaude Codeが使用可能（Claude Code Maxプラン加入時）
- 認証情報はClaude Codeデスクトップアプリから自動取得

### セッション管理の仕様
- セッションIDは各リクエストごとに新しく生成される
- `--resume`オプションで特定のセッションを再開
- 実際の会話コンテキストはサーバー側で管理される

### 対応モデル
- claude-sonnet-4-20250514 (推奨)
- claude-opus-4-20250514
